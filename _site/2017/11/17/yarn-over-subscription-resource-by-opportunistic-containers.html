<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>
        
            Over-Subscription Cluster Resource by Opportunistic Containers &middot; Streamline ONE
        
    </title>

    <script src="/theme/js/jquery-3.2.1.min.js"></script>
    <script src="/theme/js/popper.min.js"></script>
    <script src="/theme/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="/theme/css/bootstrap.css">
    <link rel="stylesheet" href="/theme/css/site.css">
    <link rel="stylesheet" href="/theme/css/syntax.css">

</head>


<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top justify-content-between">
    <a class="navbar-brand font-weight-bold" href="/index.html">Weiwei Yang</a>
    <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#navbarContent" >
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarContent">
        <ul class="navbar-nav ml-auto">
        
            <li class="nav-item">
                <a href='/index.html'
                   class="nav-link">
                    Home
                </a>
            </li>
        
            <li class="nav-item">
                <a href='/about.html'
                   class="nav-link">
                    About
                </a>
            </li>
        
            <li class="nav-item">
                <a href='/list/posts.html'
                   class="nav-link">
                    Posts
                </a>
            </li>
        
            <li class="nav-item">
                <a href='/list/portfolio.html'
                   class="nav-link">
                    Portfolio
                </a>
            </li>
        
        </ul>
    </div>
</nav>





<div class="container site-container" id="top">
    <div class="row">
        <div class="d-none d-lg-block col-lg-4 col-xl-4 side">
            








    <div class="sticky-top space-before">
    <div class="card bg-light mb-3">
        <div class="card-body">
            <div class="card-title">
                <h5>17 Nov 2017</h5>
            </div>
            <div class="d-flex flex-wrap align-items-center">
                <span class="icon grey mr-2 mb-2">
                    <?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 18.1.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->

<svg version="1.1" id="Price_tag" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve">
<g>
	<path d="M19.388,0.405c-0.111-0.314-0.454-0.48-0.769-0.371c-0.315,0.109-0.481,0.455-0.372,0.77
		c0.929,2.67-0.915,4.664-2.321,5.732l-0.568-0.814c-0.191-0.273-0.618-0.5-0.95-0.504L11.22,5.232
		c-0.332-0.006-0.825,0.146-1.097,0.338l-9.394,6.587c-0.455,0.32-0.565,0.947-0.247,1.404l4.269,6.108
		c0.32,0.455,0.831,0.4,1.287,0.082l9.394-6.588c0.27-0.191,0.582-0.603,0.692-0.918l0.998-3.145
		c0.11-0.314,0.043-0.793-0.148-1.066l-0.346-0.496C18.516,6.091,20.476,3.534,19.388,0.405z M15.017,9.763
		c-0.727,0.51-1.731,0.332-2.24-0.396c-0.511-0.73-0.333-1.734,0.395-2.246C13.75,6.716,14.5,6.745,15.04,7.138
		c-0.272,0.164-0.459,0.26-0.494,0.275c-0.301,0.143-0.43,0.504-0.288,0.805c0.104,0.219,0.321,0.348,0.547,0.348
		c0.086,0,0.174-0.02,0.257-0.059c0.194-0.092,0.402-0.201,0.619-0.33C15.778,8.771,15.542,9.394,15.017,9.763z"/>
</g>
</svg>

                </span>
                
                    <a href="/list/posts.html#yarn"
                       class="bg-white border rounded p-1 mr-2 mb-2 d-inline-block">
                        YARN
                    </a>
                
            </div>
            <div class="d-flex align-items-center mt-2">
                <span class="icon grey mr-1">
                    <?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 18.1.1, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->

<svg version="1.1" id="Arrow_left" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve">
<path d="M2.5,10L9,3.5V7h8v6H9v3.5L2.5,10z"/>
</svg>

                </span>
                <a href="/list/posts.html">Back to all posts</a>
            </div>
        </div>
    </div>
</div>






        </div>
        <div class="col-md-12 col-lg-8 col-xl-8 pb-4 content">
            <h1 class="border border-top-0 border-right-0 border-left-0 mb-3 pb-2">Over-Subscription Cluster Resource by Opportunistic Containers</h1>

<div class="d-md-block d-lg-none">
    <div class="sticky-top space-before">
    <div class="card bg-light mb-3">
        <div class="card-body">
            <div class="card-title">
                <h5>17 Nov 2017</h5>
            </div>
            <div class="d-flex flex-wrap align-items-center">
                <span class="icon grey mr-2 mb-2">
                    <?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 18.1.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->

<svg version="1.1" id="Price_tag" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve">
<g>
	<path d="M19.388,0.405c-0.111-0.314-0.454-0.48-0.769-0.371c-0.315,0.109-0.481,0.455-0.372,0.77
		c0.929,2.67-0.915,4.664-2.321,5.732l-0.568-0.814c-0.191-0.273-0.618-0.5-0.95-0.504L11.22,5.232
		c-0.332-0.006-0.825,0.146-1.097,0.338l-9.394,6.587c-0.455,0.32-0.565,0.947-0.247,1.404l4.269,6.108
		c0.32,0.455,0.831,0.4,1.287,0.082l9.394-6.588c0.27-0.191,0.582-0.603,0.692-0.918l0.998-3.145
		c0.11-0.314,0.043-0.793-0.148-1.066l-0.346-0.496C18.516,6.091,20.476,3.534,19.388,0.405z M15.017,9.763
		c-0.727,0.51-1.731,0.332-2.24-0.396c-0.511-0.73-0.333-1.734,0.395-2.246C13.75,6.716,14.5,6.745,15.04,7.138
		c-0.272,0.164-0.459,0.26-0.494,0.275c-0.301,0.143-0.43,0.504-0.288,0.805c0.104,0.219,0.321,0.348,0.547,0.348
		c0.086,0,0.174-0.02,0.257-0.059c0.194-0.092,0.402-0.201,0.619-0.33C15.778,8.771,15.542,9.394,15.017,9.763z"/>
</g>
</svg>

                </span>
                
                    <a href="/list/posts.html#yarn"
                       class="bg-white border rounded p-1 mr-2 mb-2 d-inline-block">
                        YARN
                    </a>
                
            </div>
            <div class="d-flex align-items-center mt-2">
                <span class="icon grey mr-1">
                    <?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 18.1.1, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->

<svg version="1.1" id="Arrow_left" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve">
<path d="M2.5,10L9,3.5V7h8v6H9v3.5L2.5,10z"/>
</svg>

                </span>
                <a href="/list/posts.html">Back to all posts</a>
            </div>
        </div>
    </div>
</div>

</div>

<p>Just like airline overbooks their flights, yarn can (and should) provide the capability
to overbook its resource for applications to increase the resource utilization.</p>

<!--more-->

<h3 id="motivation">Motivation</h3>

<p>One problem with yarn is that we can hardly get the cluster to reach a relative
high resource utilization due to its scheduling model. Majorly because,</p>

<ol>
  <li>Yarn containers are fixed size, once allocated, it occupies the fixed amount
of resource during its entire lifecycle. However, resource usage of an application
is changing over the time, it might consume very rare resource when it is idle
so most of time the resource is wasted. This is even worse when there is long running services.</li>
  <li>Most of user sets the resource request according to the maximum required
resource to ensure they get a predictable SLA for their applications. Again,
most of time such configuration wastes a lot of resources.</li>
</ol>

<p>Just like airline overbooks their flights, yarn can (and should) provide the capability
to overbook its resource for applications to increase the resource utilization.
This work is firstly proposed in yarn community via <a href="https://issues.apache.org/jira/browse/YARN-1011">YARN-1011</a>, this post is exploring
how this problem is solved with that approach.</p>

<h3 id="opportunistic-container">Opportunistic Container</h3>

<p>Opportunistic container is a new type of container that aims to over-subscribe system resource in order to increase resource utilization in a yarn cluster.</p>

<h4 id="guaranteed-container">Guaranteed Container</h4>

<p>Traditional container type, subscribe a fixed amount of resource from yarn cluster. Once a guaranteed container is allocated, the resource this container specified is booked from yarn capacity and yarn will ensure this amount of resource can be guaranteed at any point of time.</p>

<h4 id="opportunistic-container-1">Opportunistic Container</h4>

<p>The allocation decision for an opportunistic container is not depending on the capacity of the cluster, instead it is determined by the real time resource utilization in the cluster while the request is made. Which means, even the cluster capacity is all booked by guaranteed containers and there is no enough capacity to satisfy the desired requested resource of an
opportunistic container, it can be still allocated as long as there is free resource available on node managers. This is also called over-subscription.</p>

<p>This mechanism helps to improve the utilization of the resource. However, it is necessarily to know that yarn gives no guarantee of the resources allocated to such containers. So it might be killed or preempted when it needs to recycle some resource to avoid starving guaranteed containers.</p>

<p><img src="/assets/yarn-over-subscription-1.png" alt="Chart 1. Over-subscription" /></p>

<p>Chart 1 illustrates how the over-subscription works on a node manager. Node manager monitors the node resource usage in a certain frequency (default 3s), if it detects there is free resource available on this node, then these resource can be utilized by opportunistic containers. The total allocated the resource cannot exceed the system limit at any time.</p>

<h4 id="schedule-opportunistic-containers">Schedule Opportunistic Containers</h4>

<p>Resource manager runs an application master service processor to handle the requests from application masters, it was working like following</p>

<p><img src="/assets/yarn-over-subscription-2.png" alt="Char 2 - Current Scheduling Logic" /></p>

<p>Procedure:</p>

<ol>
  <li>Application master submits resource requests to the application master service running in the resource manager</li>
  <li>Application master service queries a specific scheduler to decide how to schedule containers</li>
  <li>Resource manager returns the scheduling decision back to application master</li>
  <li>Application master interpretes the allocation response and connects to specific node managers to launch containers</li>
</ol>

<p>With adding the concept of opportunistic containers, the procedure now looks like</p>

<p><img src="/assets/yarn-over-subscription-3.png" alt="Char 3 - Scheduling Guaranteed and Opportunistic Containers" /></p>

<p>Rest of processes remain the same, except for</p>

<ul>
  <li>There is a chain of application master service processors, the default one handles the scheduling of guaranteed containers and the opportunistic AMS processor handles the scheduling of opportunistic containers</li>
</ul>

<h4 id="over-allocation-and-preemption">Over-allocation and Preemption</h4>

<p>Node manager over-allocation and preemption is controlled by thresholds, they are configurable percentage of nodes’ resource.</p>

<p><img src="/assets/yarn-over-subscription-4.png" alt="Chart 4 - Over-allocation and Preemption" /></p>

<p>Node manager collects the memory/CPU usage by all containers from cgroups, and reports that to resource manager via heartbeat. There are two configurable thresholds, one for over-allocation and the other for preemption. When node resource utilization is under the over-allocation-threshold, this node will be scheduled with some opportunistic containers that utilizes the resource beyond this threshold and under the preemption-threshold.</p>

<p>If the resource usage exceeds the preemption-threshold, then node manager starts to preempt containers from this node to keep the utilization under this threshold.</p>



        </div>
        <div class="col-md-12 d-lg-none bottom">
            

        </div>
    </div>
</div>

<script type="text/javascript">
/*!
 * IE10 viewport hack for Surface/desktop Windows 8 bug
 * Copyright 2014-2017 The Bootstrap Authors
 * Copyright 2014-2017 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 */

// See the Getting Started docs for more information:
// https://getbootstrap.com/getting-started/#support-ie10-width

(function () {
    'use strict'

    if (navigator.userAgent.match(/IEMobile\/10\.0/)) {
        var msViewportStyle = document.createElement('style')
        msViewportStyle.appendChild(
            document.createTextNode(
                '@-ms-viewport{width:auto!important}'
            )
        )
        document.head.appendChild(msViewportStyle)
    }
}())
</script>

</body>

</html>
